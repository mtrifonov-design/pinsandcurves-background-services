{"version":3,"file":"index.js","sources":["../../src/AssetServer/index.ts"],"sourcesContent":["\ntype Asset = {\n    asset_id: string;\n    asset_name: string;\n    asset_type: string;\n    data: any;\n    width?: number;\n    height?: number;\n}\n\nclass State {\n\n    assetDB: Asset[] = [\n\n    ];\n\n    constructor() {\n    }\n\n    receiveAssets(sender_id: any,payload: Asset[]) {\n        // delete the assets that are about to be replaced\n        this.assetDB = this.assetDB.filter(asset => !payload.map(p => p.asset_id).includes(asset.asset_id));\n        this.assetDB.push(...payload);\n        const preview = this.assetDB.map(asset => {\n            return {\n                asset_id: asset.asset_id,\n                asset_name: asset.asset_name,\n                asset_type: asset.asset_type,\n                width: asset.width,\n                height: asset.height\n            }\n        });\n        console.log(\"Assets: \", preview);\n        this.emit(sender_id,payload)\n    }\n\n\n\n    sendAssets(assetIdList: string[], receiver: any) {\n        const assets = this.assetDB.filter(asset => assetIdList.includes(asset.asset_id));\n        if (assets.length === 0) return;\n        this.addToWorkload(receiver, \"assetResponse\", assets);\n    }\n\n    workload : { [thread: string]: any[]} = {};\n    addToWorkload(receiver : {\n        instance_id: string,\n        modality: string,\n        resource_id: string\n    }, request: string, messagePayload: any) {\n        if (!this.workload[\"default\"]) {\n            this.workload[\"default\"] = [];\n        }\n        this.workload[\"default\"].push(\n            {\n                type: \"worker\",\n                receiver,\n                payload: {\n                    request: request,\n                    payload: messagePayload,\n                }\n            }\n        )\n    }\n\n    clearWorkload() {\n        this.workload = {};\n    }\n\n    subscribers : { [instance_id: string]: any } = {};\n    subscribe(receiver : { instance_id: string, modality: string, resource_id: string }) {\n        this.subscribers[receiver.instance_id] = receiver;\n        this.addToWorkload(receiver, \"subscribeConfirmation\", this.assetDB);\n    }\n\n    unsubscribe(receiver: { instance_id: string, modality: string, resource_id: string }) {\n        delete this.subscribers[receiver.instance_id];\n        this.addToWorkload(receiver, \"unsubscribeConfirmation\", true);\n    }\n\n    emit(sender_id: string,payload: any) {\n        console.log(this.subscribers)\n        Object.keys(this.subscribers).forEach(subscriber_id => {\n            if (subscriber_id === sender_id) return;\n            this.addToWorkload(this.subscribers[subscriber_id], \"assetEvent\", payload);\n        })\n    }\n}\n\nconst state = new State()\n\nfunction onCompute(string: string) {\n    string = decodeURI(string);\n    const unit = JSON.parse(string);\n    const { request, payload, SAVE_SESSION, LOAD_SESSION, key, state:s  } = unit.payload;\n    // console.log(unit);\n\n    if (SAVE_SESSION) {\n        return {\n            persistence: [{\n                type: \"worker\",\n                receiver: unit.sender,\n                payload: {\n                    key,\n                    SAVE_SESSION,\n                    state: state.assetDB,\n                }\n            }]\n        };\n    }\n\n    if (LOAD_SESSION) {\n        if (s) {\n            const assetDB = s;\n            //state.subscribers = subscribers;\n            state.assetDB = assetDB;\n        }\n        return {};\n    }\n\n    if (request === \"subscribe\") {\n        state.subscribe(unit.sender);\n        const workload = state.workload;\n        state.clearWorkload();\n        return workload;\n    }\n\n    if (request === \"unsubscribe\") {\n        state.unsubscribe(unit.sender);\n        const workload = state.workload;\n        state.clearWorkload();\n        return workload;\n    }\n\n    if (request === \"pushAssets\") {\n        state.receiveAssets(unit.sender.instance_id,payload);\n        const workload = state.workload;\n        state.clearWorkload();\n        return workload;\n    } \n\n    if (request === \"requestAssets\") {\n        state.sendAssets(payload, unit.sender);\n        const workload = state.workload;\n        state.clearWorkload();\n        return workload;\n    }\n\n}\n\n\n\nonCompute(\n    decodeURI(\n        JSON.stringify({\n            payload: {\n                channel: \"SELF\",\n                request: \"getProject\",\n                payload: {}\n            }\n        })\n    )\n)\n\n\n"],"names":[],"mappings":"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"}